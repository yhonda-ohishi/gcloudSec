#!/bin/sh

# タグのみのプッシュはスキップ
while read local_ref local_sha remote_ref remote_sha; do
  if echo "$local_ref" | grep -q "^refs/tags/"; then
    exit 0
  fi
done

# npmレジストリから直接バージョン取得
CURRENT_VERSION=$(node -p "require('./package.json').version")
NPM_VERSION=$(curl -s "https://registry.npmjs.org/@yhonda%2fgcloud-secrets/latest" | node -p "JSON.parse(require('fs').readFileSync(0,'utf8')).version" 2>/dev/null || echo "0.0.0")

# バージョンが同じ or 古い場合は自動で上げて再push
if [ "$CURRENT_VERSION" = "$NPM_VERSION" ] || [ "$(printf '%s\n' "$NPM_VERSION" "$CURRENT_VERSION" | sort -V | tail -n1)" = "$NPM_VERSION" ]; then
  echo "Auto-bumping version (local: $CURRENT_VERSION, npm: $NPM_VERSION)..."
  # npm より新しいバージョンを設定
  NEW_VERSION=$(echo "$NPM_VERSION" | awk -F. '{printf "%d.%d.%d", $1, $2, $3+1}')
  npm version "$NEW_VERSION" --no-git-tag-version
  git add package.json package-lock.json
  git commit -m "v$NEW_VERSION"
  echo "Version bumped to $NEW_VERSION. Re-pushing..."
  git push
  # 元のpushを中止 (再pushでhookが再実行、version > npm なのでpublishへ)
  exit 1
fi

echo "Publishing @yhonda/gcloud-secrets@$CURRENT_VERSION to npm..."
npm publish && git tag "v$CURRENT_VERSION" && git push origin "v$CURRENT_VERSION"
