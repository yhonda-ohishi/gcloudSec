#!/bin/sh

# タグのみのプッシュはスキップ
while read local_ref local_sha remote_ref remote_sha; do
  if echo "$local_ref" | grep -q "^refs/tags/"; then
    exit 0
  fi
done

# バージョンが変更されている場合のみ npm publish を実行
CURRENT_VERSION=$(node -p "require('./package.json').version")
NPM_VERSION=$(npm view @yhonda/gcloud-secrets version 2>/dev/null || echo "0.0.0")

if [ "$CURRENT_VERSION" != "$NPM_VERSION" ]; then
  echo "Publishing @yhonda/gcloud-secrets@$CURRENT_VERSION to npm..."
  npm publish && git tag "v$CURRENT_VERSION" && git push origin "v$CURRENT_VERSION"
fi
